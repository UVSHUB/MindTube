<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Console - Nutzy Craft PilotAI</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body style="background-color: #f8f9fa;">

    <!-- Navbar: Matching Public Site Style but with Context -->
    <nav class="navbar">
        <a href="index.html" class="logo">
            <img src="images/logo.jpg" alt="Antigravity Acorn" style="height: 32px; border-radius: 50%;">
            Nutzy Craft <span>PilotAI</span>
        </a>



        <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
            <!-- Profile -->
            <a href="settings.html"
                style="display: flex; align-items: center; gap: 0.75rem; padding: 0.25rem 0.25rem 0.25rem 1rem; background: #fff; border: 1px solid var(--labs-border); border-radius: var(--radius-pill); text-decoration: none; color: inherit; transition: box-shadow 0.2s;">
                <span style="font-size: 0.9rem; font-weight: 500;"></span>
                <div
                    style="width: 32px; height: 32px; border-radius: 50%;">
                </div>
            </a>
        </div>
    </nav>

    <div class="console-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section-title">Workspace</div>
            <a href="dashboard.html" class="sidebar-link active">Analysis Console</a>
            <a href="saved-reports.html" class="sidebar-link">Saved Reports</a>
            <a href="trends.html" class="sidebar-link">Trends</a>

            <div class="sidebar-section-title">Account</div>
            <a href="settings.html" class="sidebar-link">Settings</a>

            <a href="signout.html" class="sidebar-link" style="color: #d93025; margin-top: 1rem;">Sign Out</a>
        </aside>

        <!-- Main Content -->
        <main>

            <!-- Input Card -->
            <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 3rem;">
                <div style="text-align: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">New Analysis</h2>
                    <p>Paste a YouTube URL to generate semantic insights and retention predictions.</p>
                </div>

                <div class="input-wrapper" style="padding-left: 0.75rem;">
                    <button id="attachBtn" class="btn"
                        style="width: 40px; height: 40px; border-radius: 50%; padding: 0; background: #f1f3f4; color: var(--labs-black); display: flex; align-items: center; justify-content: center; border: none; font-size: 1.5rem; flex-shrink: 0; transition: background 0.2s;">+</button>
                    <input type="text" id="videoUrlInput" class="url-input"
                        placeholder="https://youtube.com/watch?v=...">
                    <button id="analyzeBtn" class="btn btn-primary" style="padding: 0.75rem 2rem;">Analyze</button>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
                        style="display: none;">
                </div>

                <div id="fileList" style="margin-top: 1rem; display: none; text-align: left; padding: 0 1rem;"></div>

                <div id="progressSection"
                    style="display: none; margin-top: 2.5rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.5rem;">
                        <span>Processing video content...</span>
                        <span id="percentText">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <!-- Summary Card -->
                <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; gap: 1.5rem; align-items: start;">
                        <!-- Thumbnail Placeholder -->
                        <div
                            style="width: 160px; height: 90px; background: #f1f3f4; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 2rem;">‚ñ∂Ô∏è</span>
                        </div>
                        <div style="flex: 1;">
                            <h3 id="videoTitleElement"
                                style="font-size: 1.25rem; margin-bottom: 0.5rem; line-height: 1.3;">
                                Analyzing Video...</h3>
                            <div
                                style="display: flex; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--labs-grey);">
                                <span id="channelNameElement">Channel Name</span>
                                <span>‚Ä¢</span>
                                <span>1.2M Views</span>
                                <span>‚Ä¢</span>
                                <span>2 days ago</span>
                            </div>
                            <p id="videoSummaryElement"
                                style="font-size: 0.95rem; margin-bottom: 0; color: var(--labs-black);">
                                Summary will appear here after analysis.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <!-- Score Card -->
                    <div class="card" style="background: #fff; border: 1px solid var(--labs-border);">
                        <h4
                            style="color: var(--labs-grey); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                            Craft Score</h4>
                        <div style="display: flex; align-items: baseline; gap: 1rem; margin-top: 1rem;">
                            <span id="craftScoreValue"
                                style="font-size: 4rem; font-family: var(--font-head); font-weight: 700; line-height: 1;">-</span>
                            <span id="craftScoreDiff"
                                style="color: #137333; font-weight: 500; background: #e6f4ea; padding: 4px 8px; border-radius: 6px;">--</span>
                        </div>
                        <p id="analysisComment" style="margin-top: 1rem; font-size: 1.1rem;">Analysis ready.</p>
                    </div>

                    <!-- Metrics Grid -->
                    <div class="grid grid-2" style="gap: 1rem;">
                        <div class="stat-card">
                            <div id="hookScoreValue" style="font-size: 2rem; font-weight: 700;">-</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">Hook Score</div>
                        </div>
                        <div class="stat-card">
                            <div id="seoScoreValue" style="font-size: 2rem; font-weight: 700;">-</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">SEO Score</div>
                        </div>
                        <div class="stat-card">
                            <div id="retentionScoreValue" style="font-size: 2rem; font-weight: 700;">-</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">Retention Score</div>
                        </div>
                        <div class="stat-card">
                            <div id="toneMatchValue" style="font-size: 2rem; font-weight: 700;">-</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">Overall Grade</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const btn = document.getElementById('analyzeBtn');
        const attachBtn = document.getElementById('attachBtn');
        const input = document.getElementById('videoUrlInput');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');

        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const percentText = document.getElementById('percentText');
        const resultsSection = document.getElementById('resultsSection');

        let selectedFiles = [];

        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });

        attachBtn.addEventListener('mouseover', () => {
            attachBtn.style.background = '#e8eaed';
        });

        attachBtn.addEventListener('mouseout', () => {
            attachBtn.style.background = '#f1f3f4';
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            renderFileList();
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }
            fileList.style.display = 'flex';
            fileList.style.flexWrap = 'wrap';
            fileList.style.gap = '0.5rem';

            fileList.innerHTML = selectedFiles.map(file => `
                <div style="background: #fff; border: 1px solid var(--labs-border); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìÑ</span>
                    <span style="font-weight: 500;">${file.name}</span>
                    <span style="color: #d93025; cursor: pointer; font-weight: bold; margin-left: 0.25rem;" onclick="removeFile('${file.name}')">√ó</span>
                </div>
            `).join('');
        }

        // Remove file helper
        window.removeFile = function (fileName) {
            selectedFiles = selectedFiles.filter(f => f.name !== fileName);
            renderFileList();
            // Reset file input so same file can be selected again if needed
            fileInput.value = '';
        }

        // Main Analyze Function
        async function startAnalysis() {
            const hasUrl = input.value.trim().length > 0;
            const hasFiles = selectedFiles.length > 0;

            if (!hasUrl && !hasFiles) {
                input.focus();
                return;
            }

            // Get user
            const userJson = localStorage.getItem('user');
            // Allow testing without login for now if needed, or redirect
            // if (!userJson) { window.location.href = 'login.html'; return; }
            const user = userJson ? JSON.parse(userJson) : { id: 'anonymous' };

            // UI State Change
            btn.disabled = true;
            btn.innerText = 'Analyzing...';
            btn.classList.add('analyzing-state');

            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            input.disabled = true;
            attachBtn.disabled = true;

            // Simulate Progress Bar for UX (since we don't have real-time progress from backend yet)
            let width = 0;
            const interval = setInterval(() => {
                width += 1; // Slower progress
                if (width > 90) width = 90; 
                progressBar.style.width = width + '%';
                percentText.innerText = Math.round(width) + '%';
            }, 300);

            try {
                // Call Python Backend directly
                const response = await fetch('http://localhost:8000/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        youtube_url: hasUrl ? input.value : "",
                        user_id: user.id
                    })
                });

                const data = await response.json();
                clearInterval(interval);

                if (response.ok && data.success) {
                    progressBar.style.width = '100%';
                    percentText.innerText = '100%';

                    setTimeout(() => {
                        progressSection.style.display = 'none';
                        resultsSection.style.display = 'block';

                        // --- Populate Data ---
                        
                        // Metadata (Simulated since backend doesn't return title/channel yet, or we'd need another API call)
                        document.getElementById('videoTitleElement').innerText = "Analysis Result"; 
                        document.getElementById('channelNameElement').innerText = "YouTube Video ‚Ä¢ " + new Date().toLocaleDateString();
                        
                        // Summary
                        document.getElementById('videoSummaryElement').innerText = data.summary;

                        // Scores
                        document.getElementById('craftScoreValue').innerText = data.craft_score;
                        
                        // Calculate Diff (Simulated)
                        const diff = (data.craft_score - 5).toFixed(1);
                        const diffSign = diff >= 0 ? "+" : "";
                        document.getElementById('craftScoreDiff').innerText = `${diffSign}${diff} vs avg`;
                        document.getElementById('craftScoreDiff').style.color = diff >= 0 ? '#137333' : '#d93025';
                        document.getElementById('craftScoreDiff').style.background = diff >= 0 ? '#e6f4ea' : '#fce8e6';

                        // Analysis Comment
                        const comment = data.craft_score >= 8 ? "Excellent! Top tier content." : 
                                      data.craft_score >= 6 ? "Good job, but room for improvement." : "Needs optimization.";
                        document.getElementById('analysisComment').innerText = comment;

                        // Sub-metrics
                        document.getElementById('hookScoreValue').innerText = data.hook_score; // Hook
                        document.getElementById('seoScoreValue').innerText = data.seo_score;   // SEO
                        document.getElementById('retentionScoreValue').innerText = data.retention_score; // Retention
                        
                        // Grade Calculation
                        let grade = 'C';
                        if (data.craft_score >= 9) grade = 'A+';
                        else if (data.craft_score >= 8) grade = 'A';
                        else if (data.craft_score >= 7) grade = 'B';
                        else if (data.craft_score >= 5) grade = 'C';
                        else grade = 'D';
                        document.getElementById('toneMatchValue').innerText = grade;

                        // --- SAVE REPORT LOCAL STORAGE ---
                        const newReport = {
                            id: Date.now(),
                            title: "Analysis Result " + new Date().toLocaleTimeString(),
                            videoUrl: hasUrl ? input.value : "File Upload",
                            createdAt: new Date().toISOString(),
                            craftScore: data.craft_score,
                            summary: data.summary
                        };
                        
                        // Get existing
                        let reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
                        // Add new to top
                        reports.unshift(newReport);
                        // Save back
                        localStorage.setItem('savedReports', JSON.stringify(reports));

                        // Reset UI
                        input.value = '';
                        selectedFiles = [];
                        renderFileList();
                    }, 500);
                } else {
                    throw new Error(data.detail || data.error || "Analysis failed");
                }

            } catch (e) {
                console.error(e);
                clearInterval(interval);
                alert("Analysis failed: " + e.message);
                progressSection.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.innerText = 'Analyze';
                btn.classList.remove('analyzing-state');
                input.disabled = false;
                attachBtn.disabled = false;
            }
        }

        // Attach event listener
        btn.addEventListener('click', startAnalysis);

        async function loadUserProfile() {
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                // Not logged in -> Redirect
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userJson);
            // Verify with backend
            try {
                const res = await fetch(`/api/user/me?userId=${user.id}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        // Update Navbar
                        const profileName = document.querySelector('.navbar a[href="settings.html"] span');
                        const profileAvatar = document.querySelector('.navbar a[href="settings.html"] div');

                        if (profileName) profileName.innerText = data.fullName || user.name || "User";
                        if (profileAvatar && data.avatarUrl) {
                            profileAvatar.style.background = 'none';
                            profileAvatar.style.backgroundImage = `url('${data.avatarUrl}')`;
                            profileAvatar.style.backgroundSize = 'cover';
                            profileAvatar.style.backgroundPosition = 'center';
                        } else if (profileAvatar) {
                            // Use gradient if no avatar
                            profileAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                            profileAvatar.style.backgroundImage = 'none';
                        }
                    }
                } else {
                    // Session invalid?
                    // console.warn("Session check failed");
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Run on load
        document.addEventListener('DOMContentLoaded', loadUserProfile);
    </script>
</body>

</html>