<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Console - Nutzy Craft PilotAI</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Google API for Drive Integration -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body style="background-color: #f8f9fa;">

    <!-- Navbar: Matching Public Site Style but with Context -->
    <nav class="navbar">
        <a href="index.html" class="logo">
            <img src="images/logo.jpg" alt="Antigravity Acorn" style="height: 32px; border-radius: 50%;">
            Nutzy Craft <span>PilotAI</span>
        </a>



        <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
            <!-- Profile -->
            <a href="settings.html"
                style="display: flex; align-items: center; gap: 0.75rem; padding: 0.25rem 0.25rem 0.25rem 1rem; background: #fff; border: 1px solid var(--labs-border); border-radius: var(--radius-pill); text-decoration: none; color: inherit; transition: box-shadow 0.2s;">
                <span style="font-size: 0.9rem; font-weight: 500;"></span>
                <div
                    style="width: 32px; height: 32px; border-radius: 50%;">
                </div>
            </a>
        </div>
    </nav>

    <div class="console-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section-title">Workspace</div>
            <a href="dashboard.html" class="sidebar-link active">Video Analysis</a>

            <div class="sidebar-section-title">Account</div>
            <a href="settings.html" class="sidebar-link">Settings</a>

            <a href="signout.html" class="sidebar-link" style="color: #d93025; margin-top: 1rem;">Sign Out</a>
        </aside>

        <!-- Main Content -->
        <main>

            <!-- Input Card -->
            <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 3rem;">
                <div style="text-align: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">Analyze Learning Video</h2>
                    <p>Paste a YouTube URL to get a clear summary and grasp the core concepts of any educational video.</p>
                </div>

                <div class="input-wrapper" style="padding-left: 0.75rem;">
                    <button id="attachBtn" class="btn"
                        style="width: 40px; height: 40px; border-radius: 50%; padding: 0; background: #f1f3f4; color: var(--labs-black); display: flex; align-items: center; justify-content: center; border: none; font-size: 1.5rem; flex-shrink: 0; transition: background 0.2s;">+</button>
                    <input type="text" id="videoUrlInput" class="url-input"
                        placeholder="https://youtube.com/watch?v=...">
                    <button id="analyzeBtn" class="btn btn-primary" style="padding: 0.75rem 2rem;">Analyze</button>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
                        style="display: none;">
                </div>

                <div id="fileList" style="margin-top: 1rem; display: none; text-align: left; padding: 0 1rem;"></div>

                <div id="progressSection"
                    style="display: none; margin-top: 2.5rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.5rem;">
                        <span>Processing video content...</span>
                        <span id="percentText">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <!-- Video Info Card -->
                <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; gap: 1.5rem; align-items: start; margin-bottom: 2rem;">
                        <!-- Subject Icon -->
                        <div
                            style="width: 160px; height: 90px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 0.5rem;">
                            <span style="font-size: 2.5rem;">üéì</span>
                            <span id="difficultyBadge" style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: 600;">Loading...</span>
                        </div>
                        <div style="flex: 1;">
                            <h3 id="videoTitleElement"
                                style="font-size: 1.5rem; margin-bottom: 0.5rem; line-height: 1.3; color: var(--labs-black);">
                                Analyzing Video...</h3>
                            <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--labs-grey);">
                                <span id="subjectAreaElement">üìö Preparing content...</span>
                            </div>
                            <p id="videoSummaryElement" style="font-size: 0.95rem; line-height: 1.6; color: var(--labs-black); margin: 0;">
                                Summary will appear here after analysis.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Prerequisites Card -->
                <div class="card mb-4" style="background: #fff3cd; border: 1px solid #ffc107; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <span style="font-size: 1.3rem;">‚ö†Ô∏è</span>
                        <h4 style="font-size: 1rem; font-weight: 600; margin: 0; color: #856404;">Prerequisites</h4>
                    </div>
                    <ul id="prerequisitesElement" style="margin: 0; padding-left: 1.5rem; color: #856404; line-height: 1.8;">
                        <li>Loading prerequisites...</li>
                    </ul>
                </div>

                <!-- Learning Objectives Card -->
                <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">üéØ</span>
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Learning Objectives</h4>
                    </div>
                    <div id="learningObjectivesElement" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <p style="margin: 0; color: var(--labs-grey);">Loading objectives...</p>
                    </div>
                </div>

                <!-- Detailed Explanation Card -->
                <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">üìñ</span>
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Detailed Explanation</h4>
                    </div>
                    <div id="detailedExplanationElement" style="font-size: 1.05rem; line-height: 1.8; color: var(--labs-black);">
                        <p>Processing video content...</p>
                    </div>
                </div>

                <!-- Key Concepts Card -->
                <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">üí°</span>
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Key Concepts</h4>
                    </div>
                    <div id="keyConceptsElement" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <p style="margin: 0;">Loading concepts...</p>
                        </div>
                    </div>
                </div>

                <!-- Examples Covered Card -->
                <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">üìù</span>
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Examples & Demonstrations</h4>
                    </div>
                    <div id="examplesElement" style="display: flex; flex-direction: column; gap: 1rem;">
                        <p style="margin: 0; color: var(--labs-grey);">Loading examples...</p>
                    </div>
                </div>

                <!-- Key Takeaways Card -->
                <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 2rem; color: white;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">‚≠ê</span>
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Key Takeaways</h4>
                    </div>
                    <ul id="keyTakeawaysElement" style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li>Loading key takeaways...</li>
                    </ul>
                </div>

                <!-- Save Options Card -->
                <div class="card" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">üíæ</span>
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Save Summary</h4>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button id="savePdfBtn" class="btn" style="padding: 0.75rem 1.5rem; background: #d93025; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;">
                            <span style="font-size: 1.2rem;">üìÑ</span>
                            Save as PDF
                        </button>
                        <button id="saveDriveBtn" class="btn" style="padding: 0.75rem 1.5rem; background: #4285f4; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;">
                            <span style="font-size: 1.2rem;">‚òÅÔ∏è</span>
                            Save to Google Drive
                        </button>
                    </div>
                    <p id="saveStatus" style="margin-top: 1rem; font-size: 0.9rem; color: var(--labs-grey); display: none;"></p>
                </div>
            </div>

        </main>
    </div>

    <script>
        const btn = document.getElementById('analyzeBtn');
        const attachBtn = document.getElementById('attachBtn');
        const input = document.getElementById('videoUrlInput');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');

        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const percentText = document.getElementById('percentText');
        const resultsSection = document.getElementById('resultsSection');

        let selectedFiles = [];

        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });

        attachBtn.addEventListener('mouseover', () => {
            attachBtn.style.background = '#e8eaed';
        });

        attachBtn.addEventListener('mouseout', () => {
            attachBtn.style.background = '#f1f3f4';
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            renderFileList();
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }
            fileList.style.display = 'flex';
            fileList.style.flexWrap = 'wrap';
            fileList.style.gap = '0.5rem';

            fileList.innerHTML = selectedFiles.map(file => `
                <div style="background: #fff; border: 1px solid var(--labs-border); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìÑ</span>
                    <span style="font-weight: 500;">${file.name}</span>
                    <span style="color: #d93025; cursor: pointer; font-weight: bold; margin-left: 0.25rem;" onclick="removeFile('${file.name}')">√ó</span>
                </div>
            `).join('');
        }

        // Remove file helper
        window.removeFile = function (fileName) {
            selectedFiles = selectedFiles.filter(f => f.name !== fileName);
            renderFileList();
            // Reset file input so same file can be selected again if needed
            fileInput.value = '';
        }

        // Main Analyze Function
        async function startAnalysis() {
            const hasUrl = input.value.trim().length > 0;
            const hasFiles = selectedFiles.length > 0;

            if (!hasUrl && !hasFiles) {
                input.focus();
                return;
            }

            // Get user
            const userJson = localStorage.getItem('user');
            // Allow testing without login for now if needed, or redirect
            // if (!userJson) { window.location.href = 'login.html'; return; }
            const user = userJson ? JSON.parse(userJson) : { id: 'anonymous' };

            // UI State Change
            btn.disabled = true;
            btn.innerText = 'Analyzing...';
            btn.classList.add('analyzing-state');

            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            input.disabled = true;
            attachBtn.disabled = true;

            // Simulate Progress Bar for UX (since we don't have real-time progress from backend yet)
            let width = 0;
            const interval = setInterval(() => {
                width += 1; // Slower progress
                if (width > 90) width = 90; 
                progressBar.style.width = width + '%';
                percentText.innerText = Math.round(width) + '%';
            }, 300);

            try {
                // Call Python Backend directly
                const response = await fetch('http://localhost:8000/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        youtube_url: hasUrl ? input.value : "",
                        user_id: user.id
                    })
                });

                const data = await response.json();
                clearInterval(interval);

                if (response.ok && data.success) {
                    progressBar.style.width = '100%';
                    percentText.innerText = '100%';

                    setTimeout(() => {
                        progressSection.style.display = 'none';
                        resultsSection.style.display = 'block';

                        // --- Populate Educational Content ---
                        
                        // Store data for PDF/Drive export
                        currentAnalysisData = data;
                        
                        // Video Title & Subject
                        document.getElementById('videoTitleElement').innerText = data.title || "Educational Video Content"; 
                        document.getElementById('subjectAreaElement').innerText = "üìö " + (data.subject_area || "General Education");
                        
                        // Difficulty Badge
                        const diffBadge = document.getElementById('difficultyBadge');
                        diffBadge.innerText = data.difficulty_level || "Intermediate";
                        
                        // Summary
                        document.getElementById('videoSummaryElement').innerText = data.summary || "This video covers important educational content.";

                        // Prerequisites
                        const prereqElement = document.getElementById('prerequisitesElement');
                        if (data.prerequisites && data.prerequisites.length > 0) {
                            prereqElement.innerHTML = data.prerequisites.map(prereq => 
                                `<li>${prereq}</li>`
                            ).join('');
                        } else {
                            prereqElement.innerHTML = '<li>No specific prerequisites required</li>';
                        }

                        // Learning Objectives
                        const objectivesElement = document.getElementById('learningObjectivesElement');
                        if (data.learning_objectives && data.learning_objectives.length > 0) {
                            objectivesElement.innerHTML = data.learning_objectives.map((obj, idx) => `
                                <div style="display: flex; gap: 0.75rem; align-items: start;">
                                    <span style="background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; flex-shrink: 0;">${idx + 1}</span>
                                    <p style="margin: 0; line-height: 1.6; color: var(--labs-black);">${obj}</p>
                                </div>
                            `).join('');
                        } else {
                            objectivesElement.innerHTML = '<p style="margin: 0; color: var(--labs-grey);">Learning objectives not specified</p>';
                        }

                        // Detailed Explanation
                        const explanationElement = document.getElementById('detailedExplanationElement');
                        if (data.detailed_explanation) {
                            // Split into paragraphs for better readability
                            const paragraphs = data.detailed_explanation.split('\n\n').filter(p => p.trim());
                            explanationElement.innerHTML = paragraphs.map(para => 
                                `<p style="margin-bottom: 1.5rem;">${para.trim()}</p>`
                            ).join('');
                        } else {
                            explanationElement.innerHTML = '<p>No detailed explanation available</p>';
                        }

                        // Key Concepts
                        const conceptsElement = document.getElementById('keyConceptsElement');
                        if (data.key_concepts && data.key_concepts.length > 0) {
                            conceptsElement.innerHTML = data.key_concepts.map(concept => `
                                <div style="padding: 1rem 1.25rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border-left: 3px solid #667eea;">
                                    <p style="margin: 0; font-weight: 500; color: var(--labs-black);">${concept}</p>
                                </div>
                            `).join('');
                        } else {
                            conceptsElement.innerHTML = '<div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;"><p style="margin: 0;">No key concepts extracted</p></div>';
                        }

                        // Examples
                        const examplesElement = document.getElementById('examplesElement');
                        if (data.examples_covered && data.examples_covered.length > 0) {
                            examplesElement.innerHTML = data.examples_covered.map((example, idx) => `
                                <div style="padding: 1rem; background: #f8f9fa; border-left: 3px solid #764ba2; border-radius: 6px;">
                                    <p style="margin: 0; line-height: 1.6; color: var(--labs-black);"><strong>Example ${idx + 1}:</strong> ${example}</p>
                                </div>
                            `).join('');
                        } else {
                            examplesElement.innerHTML = '<p style="margin: 0; color: var(--labs-grey);">No specific examples identified</p>';
                        }

                        // Key Takeaways
                        const takeawaysElement = document.getElementById('keyTakeawaysElement');
                        if (data.key_takeaways && data.key_takeaways.length > 0) {
                            takeawaysElement.innerHTML = data.key_takeaways.map(takeaway => 
                                `<li style="margin-bottom: 0.5rem;">${takeaway}</li>`
                            ).join('');
                        } else {
                            takeawaysElement.innerHTML = '<li>Review the detailed explanation above</li>';
                        }

                        // --- SAVE REPORT LOCAL STORAGE ---
                        const newReport = {
                            id: Date.now(),
                            title: data.title || "Video Analysis " + new Date().toLocaleTimeString(),
                            videoUrl: hasUrl ? input.value : "File Upload",
                            createdAt: new Date().toISOString(),
                            summary: data.summary,
                            subject_area: data.subject_area,
                            difficulty_level: data.difficulty_level
                        };
                        
                        // Get existing
                        let reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
                        // Add new to top
                        reports.unshift(newReport);
                        // Save back
                        localStorage.setItem('savedReports', JSON.stringify(reports));

                        // Reset UI
                        input.value = '';
                        selectedFiles = [];
                        renderFileList();
                    }, 500);
                } else {
                    throw new Error(data.detail || data.error || "Analysis failed");
                }

            } catch (e) {
                console.error(e);
                clearInterval(interval);
                alert("Analysis failed: " + e.message);
                progressSection.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.innerText = 'Analyze';
                btn.classList.remove('analyzing-state');
                input.disabled = false;
                attachBtn.disabled = false;
            }
        }

        // Attach event listener
        btn.addEventListener('click', startAnalysis);

        async function loadUserProfile() {
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                // Not logged in -> Redirect
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userJson);
            // Verify with backend
            try {
                const res = await fetch(`/api/user/me?userId=${user.id}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        // Update Navbar
                        const profileName = document.querySelector('.navbar a[href="settings.html"] span');
                        const profileAvatar = document.querySelector('.navbar a[href="settings.html"] div');

                        if (profileName) profileName.innerText = data.fullName || user.name || "User";
                        if (profileAvatar && data.avatarUrl) {
                            profileAvatar.style.background = 'none';
                            profileAvatar.style.backgroundImage = `url('${data.avatarUrl}')`;
                            profileAvatar.style.backgroundSize = 'cover';
                            profileAvatar.style.backgroundPosition = 'center';
                        } else if (profileAvatar) {
                            // Use gradient if no avatar
                            profileAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                            profileAvatar.style.backgroundImage = 'none';
                        }
                    }
                } else {
                    // Session invalid?
                    // console.warn("Session check failed");
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Run on load
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            initializeGoogleAPIs();
        });

        // Initialize Google APIs after page load
        function initializeGoogleAPIs() {
            // Wait for scripts to load
            const checkInterval = setInterval(() => {
                if (typeof gapi !== 'undefined') {
                    clearInterval(checkInterval);
                    gapiLoaded();
                }
            }, 100);

            const checkGISInterval = setInterval(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    clearInterval(checkGISInterval);
                    gisLoaded();
                }
            }, 100);

            // Timeout after 10 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                clearInterval(checkGISInterval);
                if (!gapiInited || !gisInited) {
                    console.error('‚ùå Timeout waiting for Google APIs to load');
                    console.log('GAPI loaded:', typeof gapi !== 'undefined', 'GIS loaded:', typeof google !== 'undefined');
                }
            }, 10000);
        }

        // ==================== SAVE AS PDF FUNCTIONALITY ====================
        let currentAnalysisData = null; // Store current analysis data

        document.getElementById('savePdfBtn')?.addEventListener('click', generatePDF);

        async function generatePDF() {
            if (!currentAnalysisData) {
                alert('No analysis data available to save.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;
            let yPosition = margin;

            // Helper function to add text with word wrap
            function addText(text, fontSize, fontStyle = 'normal', color = [0, 0, 0]) {
                doc.setFontSize(fontSize);
                doc.setFont('helvetica', fontStyle);
                doc.setTextColor(...color);
                const lines = doc.splitTextToSize(text, maxWidth);
                
                // Check if we need a new page
                if (yPosition + (lines.length * fontSize * 0.5) > pageHeight - margin) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                doc.text(lines, margin, yPosition);
                yPosition += lines.length * fontSize * 0.5 + 5;
            }

            // Helper to add colored box
            function addColorBox(text, bgColor, textColor) {
                doc.setFillColor(...bgColor);
                doc.setDrawColor(...bgColor);
                const boxHeight = 10;
                doc.roundedRect(margin, yPosition - 7, maxWidth, boxHeight, 2, 2, 'F');
                doc.setTextColor(...textColor);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(text, margin + 3, yPosition);
                yPosition += boxHeight + 3;
            }

            // Header with gradient effect (simulated with boxes)
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, pageWidth, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('Learning Summary', pageWidth / 2, 20, { align: 'center' });
            yPosition = 45;
            
            // Video Title with background
            doc.setFillColor(245, 247, 250);
            doc.roundedRect(margin, yPosition - 5, maxWidth, 20, 3, 3, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            const titleLines = doc.splitTextToSize(currentAnalysisData.title || 'Educational Video Analysis', maxWidth - 10);
            doc.text(titleLines, margin + 5, yPosition + 5);
            yPosition += 25;
            
            // Subject and Difficulty badges
            doc.setFillColor(102, 126, 234);
            doc.setDrawColor(102, 126, 234);
            doc.roundedRect(margin, yPosition, 60, 8, 2, 2, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('SUBJECT', margin + 3, yPosition + 5);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(currentAnalysisData.subject_area || 'General', margin + 65, yPosition + 5);
            
            yPosition += 10;
            
            doc.setFillColor(118, 75, 162);
            doc.setDrawColor(118, 75, 162);
            doc.roundedRect(margin, yPosition, 60, 8, 2, 2, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('DIFFICULTY', margin + 3, yPosition + 5);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(currentAnalysisData.difficulty_level || 'Intermediate', margin + 65, yPosition + 5);
            yPosition += 15;
            
            // Summary Section
            addColorBox('SUMMARY', [102, 126, 234], [255, 255, 255]);
            addText(currentAnalysisData.summary || '', 10, 'normal');
            yPosition += 5;
            
            // Prerequisites
            if (currentAnalysisData.prerequisites && currentAnalysisData.prerequisites.length > 0) {
                addColorBox('PREREQUISITES', [255, 193, 7], [0, 0, 0]);
                currentAnalysisData.prerequisites.forEach((prereq, idx) => {
                    addText(`${idx + 1}. ${prereq}`, 10, 'normal');
                });
                yPosition += 5;
            }
            
            // Learning Objectives
            if (currentAnalysisData.learning_objectives && currentAnalysisData.learning_objectives.length > 0) {
                addColorBox('LEARNING OBJECTIVES', [76, 175, 80], [255, 255, 255]);
                currentAnalysisData.learning_objectives.forEach((obj, idx) => {
                    addText(`${idx + 1}. ${obj}`, 10, 'normal');
                });
                yPosition += 5;
            }
            
            // Key Concepts
            if (currentAnalysisData.key_concepts && currentAnalysisData.key_concepts.length > 0) {
                addColorBox('KEY CONCEPTS', [33, 150, 243], [255, 255, 255]);
                currentAnalysisData.key_concepts.forEach((concept) => {
                    addText(`‚Ä¢ ${concept}`, 10, 'normal');
                });
                yPosition += 5;
            }
            
            // Detailed Explanation
            if (currentAnalysisData.detailed_explanation) {
                addColorBox('DETAILED EXPLANATION', [156, 39, 176], [255, 255, 255]);
                addText(currentAnalysisData.detailed_explanation, 10, 'normal');
                yPosition += 5;
            }
            
            // Examples
            if (currentAnalysisData.examples_covered && currentAnalysisData.examples_covered.length > 0) {
                addColorBox('EXAMPLES & DEMONSTRATIONS', [255, 152, 0], [255, 255, 255]);
                currentAnalysisData.examples_covered.forEach((example, idx) => {
                    addText(`Example ${idx + 1}: ${example}`, 10, 'normal');
                });
                yPosition += 5;
            }
            
            // Key Takeaways
            if (currentAnalysisData.key_takeaways && currentAnalysisData.key_takeaways.length > 0) {
                addColorBox('KEY TAKEAWAYS', [233, 30, 99], [255, 255, 255]);
                currentAnalysisData.key_takeaways.forEach((takeaway, idx) => {
                    addText(`${idx + 1}. ${takeaway}`, 10, 'normal');
                });
            }
            
            // Footer with gradient
            const footerY = pageHeight - 15;
            doc.setFillColor(102, 126, 234);
            doc.rect(0, footerY, pageWidth, 15, 'F');
            doc.setFontSize(8);
            doc.setTextColor(255, 255, 255);
            doc.text(`Generated on ${new Date().toLocaleString()} | MindTube Learning Assistant`, pageWidth / 2, footerY + 10, { align: 'center' });
            
            // Save the PDF
            const fileName = `${currentAnalysisData.title?.replace(/[^a-z0-9]/gi, '_').substring(0, 50) || 'learning_summary'}.pdf`;
            doc.save(fileName);
            
            showSaveStatus('PDF saved successfully! ‚úÖ', 'success');
        }

        // ==================== GOOGLE DRIVE INTEGRATION ====================
        const CLIENT_ID = '613986529272-sn9pj1apoer7vl9jaehjmoabs7uplefu.apps.googleusercontent.com';
        const API_KEY = ''; // Not required for OAuth flow
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        document.getElementById('saveDriveBtn')?.addEventListener('click', handleDriveSave);

        // Initialize Google API
        function gapiLoaded() {
            console.log('GAPI script loaded, initializing client...');
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gapiInited = true;
                console.log('‚úÖ Google API client initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing Google API:', error);
                gapiInited = false;
            }
        }

        function gisLoaded() {
            console.log('GIS script loaded, initializing token client...');
            try {
                if (typeof google === 'undefined' || !google.accounts) {
                    console.error('‚ùå Google Identity Services library not loaded');
                    return;
                }
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // defined later
                });
                gisInited = true;
                console.log('‚úÖ Google Identity Services initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing GIS:', error);
                gisInited = false;
            }
        }

        async function handleDriveSave() {
            if (!currentAnalysisData) {
                alert('No analysis data available to save.');
                return;
            }

            // Check if user has configured Google Drive (CLIENT_ID is set)
            if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID' || !CLIENT_ID) {
                alert('Google Drive integration is not configured. Please set up your Google Client ID in the code.\n\nAlternatively, use "Save as PDF" to download the summary locally.');
                return;
            }

            // Check if Google APIs are loaded
            if (!gapiInited || !gisInited) {
                showSaveStatus('Initializing Google Drive connection...', 'info');
                console.log('GAPI initialized:', gapiInited, 'GIS initialized:', gisInited);
                
                // Wait up to 5 seconds for APIs to load
                let attempts = 0;
                while ((!gapiInited || !gisInited) && attempts < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (!gapiInited || !gisInited) {
                    showSaveStatus('Failed to load Google Drive APIs. Please refresh the page and try again.', 'error');
                    console.error('Google APIs failed to initialize. GAPI:', gapiInited, 'GIS:', gisInited);
                    return;
                }
            }

            showSaveStatus('Authenticating with Google Drive...', 'info');

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showSaveStatus('Authentication failed: ' + resp.error, 'error');
                    return;
                }
                accessToken = resp.access_token;
                await uploadToDrive();
            };

            if (accessToken === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        async function uploadToDrive() {
            try {
                showSaveStatus('Creating document...', 'info');

                // Generate PDF blob using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const maxWidth = pageWidth - 2 * margin;
                let yPosition = margin;

                // Helper function (same as generatePDF)
                function addText(text, fontSize, fontStyle = 'normal', color = [0, 0, 0]) {
                    doc.setFontSize(fontSize);
                    doc.setFont('helvetica', fontStyle);
                    doc.setTextColor(...color);
                    const lines = doc.splitTextToSize(text, maxWidth);
                    if (yPosition + (lines.length * fontSize * 0.5) > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    doc.text(lines, margin, yPosition);
                    yPosition += lines.length * fontSize * 0.5 + 5;
                }

                function addColorBox(text, bgColor, textColor) {
                    doc.setFillColor(...bgColor);
                    const boxHeight = 10;
                    doc.roundedRect(margin, yPosition - 7, maxWidth, boxHeight, 2, 2, 'F');
                    doc.setTextColor(...textColor);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(text, margin + 3, yPosition);
                    yPosition += boxHeight + 3;
                }

                // Build PDF content (same as generatePDF)
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 35, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('Learning Summary', pageWidth / 2, 20, { align: 'center' });
                yPosition = 45;
                
                doc.setFillColor(245, 247, 250);
                doc.roundedRect(margin, yPosition - 5, maxWidth, 20, 3, 3, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                const titleLines = doc.splitTextToSize(currentAnalysisData.title || 'Educational Video Analysis', maxWidth - 10);
                doc.text(titleLines, margin + 5, yPosition + 5);
                yPosition += 25;
                
                // Badges
                doc.setFillColor(102, 126, 234);
                doc.roundedRect(margin, yPosition, 60, 8, 2, 2, 'FD');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('SUBJECT', margin + 3, yPosition + 5);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(currentAnalysisData.subject_area || 'General', margin + 65, yPosition + 5);
                yPosition += 10;
                
                doc.setFillColor(118, 75, 162);
                doc.roundedRect(margin, yPosition, 60, 8, 2, 2, 'FD');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('DIFFICULTY', margin + 3, yPosition + 5);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(currentAnalysisData.difficulty_level || 'Intermediate', margin + 65, yPosition + 5);
                yPosition += 15;
                
                // Content sections
                if (currentAnalysisData.summary) {
                    addColorBox('SUMMARY', [102, 126, 234], [255, 255, 255]);
                    addText(currentAnalysisData.summary, 10, 'normal');
                    yPosition += 5;
                }
                
                if (currentAnalysisData.prerequisites?.length > 0) {
                    addColorBox('PREREQUISITES', [255, 193, 7], [0, 0, 0]);
                    currentAnalysisData.prerequisites.forEach((p, i) => addText(`${i + 1}. ${p}`, 10, 'normal'));
                    yPosition += 5;
                }
                
                if (currentAnalysisData.learning_objectives?.length > 0) {
                    addColorBox('LEARNING OBJECTIVES', [76, 175, 80], [255, 255, 255]);
                    currentAnalysisData.learning_objectives.forEach((o, i) => addText(`${i + 1}. ${o}`, 10, 'normal'));
                    yPosition += 5;
                }
                
                if (currentAnalysisData.key_concepts?.length > 0) {
                    addColorBox('KEY CONCEPTS', [33, 150, 243], [255, 255, 255]);
                    currentAnalysisData.key_concepts.forEach(c => addText(`‚Ä¢ ${c}`, 10, 'normal'));
                    yPosition += 5;
                }
                
                if (currentAnalysisData.detailed_explanation) {
                    addColorBox('DETAILED EXPLANATION', [156, 39, 176], [255, 255, 255]);
                    addText(currentAnalysisData.detailed_explanation, 10, 'normal');
                    yPosition += 5;
                }
                
                if (currentAnalysisData.examples_covered?.length > 0) {
                    addColorBox('EXAMPLES & DEMONSTRATIONS', [255, 152, 0], [255, 255, 255]);
                    currentAnalysisData.examples_covered.forEach((e, i) => addText(`Example ${i + 1}: ${e}`, 10, 'normal'));
                    yPosition += 5;
                }
                
                if (currentAnalysisData.key_takeaways?.length > 0) {
                    addColorBox('KEY TAKEAWAYS', [233, 30, 99], [255, 255, 255]);
                    currentAnalysisData.key_takeaways.forEach((t, i) => addText(`${i + 1}. ${t}`, 10, 'normal'));
                }
                
                // Footer
                const footerY = pageHeight - 15;
                doc.setFillColor(102, 126, 234);
                doc.rect(0, footerY, pageWidth, 15, 'F');
                doc.setFontSize(8);
                doc.setTextColor(255, 255, 255);
                doc.text(`Generated on ${new Date().toLocaleString()} | MindTube Learning Assistant`, pageWidth / 2, footerY + 10, { align: 'center' });

                // Convert to blob
                const pdfBlob = doc.output('blob');
                const metadata = {
                    name: `${currentAnalysisData.title?.replace(/[^a-z0-9]/gi, '_').substring(0, 50) || 'learning_summary'}.pdf`,
                    mimeType: 'application/pdf',
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', pdfBlob);

                showSaveStatus('Uploading to Google Drive...', 'info');

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ Authorization: 'Bearer ' + accessToken }),
                    body: form,
                });

                const result = await response.json();
                
                if (response.ok) {
                    showSaveStatus('Successfully saved to Google Drive! ‚úÖ', 'success');
                } else {
                    showSaveStatus('Failed to save to Google Drive: ' + (result.error?.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error uploading to Drive:', error);
                showSaveStatus('Error: ' + error.message, 'error');
            }
        }

        function showSaveStatus(message, type) {
            const statusEl = document.getElementById('saveStatus');
            if (statusEl) {
                statusEl.style.display = 'block';
                statusEl.innerText = message;
                statusEl.style.color = type === 'success' ? '#137333' : type === 'error' ? '#d93025' : '#5f6368';
                
                if (type === 'success') {
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            }
        }
    </script>
</body>

</html>