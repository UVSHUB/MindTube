<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Console - Nutzy Craft PilotAI</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body style="background-color: #f8f9fa;">

    <!-- Navbar: Matching Public Site Style but with Context -->
    <nav class="navbar">
        <a href="index.html" class="logo">
            <img src="images/logo.jpg" alt="Antigravity Acorn" style="height: 32px; border-radius: 50%;">
            Nutzy Craft <span>PilotAI</span>
        </a>



        <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
            <!-- Profile -->
            <a href="settings.html"
                style="display: flex; align-items: center; gap: 0.75rem; padding: 0.25rem 0.25rem 0.25rem 1rem; background: #fff; border: 1px solid var(--labs-border); border-radius: var(--radius-pill); text-decoration: none; color: inherit; transition: box-shadow 0.2s;">
                <span style="font-size: 0.9rem; font-weight: 500;">Sayura Thejan</span>
                <div
                    style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%;">
                </div>
            </a>
        </div>
    </nav>

    <div class="console-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section-title">Workspace</div>
            <a href="dashboard.html" class="sidebar-link active">Analysis Console</a>
            <a href="saved-reports.html" class="sidebar-link">Saved Reports</a>
            <a href="trends.html" class="sidebar-link">Trends</a>

            <div class="sidebar-section-title">Account</div>
            <a href="settings.html" class="sidebar-link">Settings</a>

            <a href="signout.html" class="sidebar-link" style="color: #d93025; margin-top: 1rem;">Sign Out</a>
        </aside>

        <!-- Main Content -->
        <main>

            <!-- Input Card -->
            <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 3rem;">
                <div style="text-align: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">New Analysis</h2>
                    <p>Paste a YouTube URL to generate semantic insights and retention predictions.</p>
                </div>

                <div class="input-wrapper" style="padding-left: 0.75rem;">
                    <button id="attachBtn" class="btn"
                        style="width: 40px; height: 40px; border-radius: 50%; padding: 0; background: #f1f3f4; color: var(--labs-black); display: flex; align-items: center; justify-content: center; border: none; font-size: 1.5rem; flex-shrink: 0; transition: background 0.2s;">+</button>
                    <input type="text" id="videoUrlInput" class="url-input"
                        placeholder="https://youtube.com/watch?v=...">
                    <button id="analyzeBtn" class="btn btn-primary" style="padding: 0.75rem 2rem;">Analyze</button>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
                        style="display: none;">
                </div>

                <div id="fileList" style="margin-top: 1rem; display: none; text-align: left; padding: 0 1rem;"></div>

                <div id="progressSection"
                    style="display: none; margin-top: 2.5rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.5rem;">
                        <span>Processing video content...</span>
                        <span id="percentText">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" style="display: none;">
                <!-- Summary Card -->
                <div class="card mb-4" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                    <div style="display: flex; gap: 1.5rem; align-items: start;">
                        <!-- Thumbnail Placeholder -->
                        <div
                            style="width: 160px; height: 90px; background: #f1f3f4; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 2rem;">‚ñ∂Ô∏è</span>
                        </div>
                        <div style="flex: 1;">
                            <h3 id="videoTitleElement"
                                style="font-size: 1.25rem; margin-bottom: 0.5rem; line-height: 1.3;">
                                Analyzing Video...</h3>
                            <div
                                style="display: flex; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--labs-grey);">
                                <span id="channelNameElement">Channel Name</span>
                                <span>‚Ä¢</span>
                                <span>1.2M Views</span>
                                <span>‚Ä¢</span>
                                <span>2 days ago</span>
                            </div>
                            <p id="videoSummaryElement"
                                style="font-size: 0.95rem; margin-bottom: 0; color: var(--labs-black);">
                                Summary will appear here after analysis.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <!-- Score Card -->
                    <div class="card" style="background: #fff; border: 1px solid var(--labs-border);">
                        <h4
                            style="color: var(--labs-grey); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                            Craft Score</h4>
                        <div style="display: flex; align-items: baseline; gap: 1rem; margin-top: 1rem;">
                            <span
                                style="font-size: 4rem; font-family: var(--font-head); font-weight: 700; line-height: 1;">94</span>
                            <span
                                style="color: #137333; font-weight: 500; background: #e6f4ea; padding: 4px 8px; border-radius: 6px;">+12%
                                vs avg</span>
                        </div>
                        <p style="margin-top: 1rem; font-size: 1.1rem;">Excellent retention velocity. Your hook is
                            performing in the top 5% of your niche.</p>
                    </div>

                    <!-- Metrics Grid -->
                    <div class="grid grid-2" style="gap: 1rem;">
                        <div class="stat-card">
                            <div style="font-size: 2rem; font-weight: 700;">High</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">Pacing Score</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 2rem; font-weight: 700;">8.5</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">Clarity</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 2rem; font-weight: 700;">+40s</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">Est. Retention</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 2rem; font-weight: 700;">A+</div>
                            <div style="font-size: 0.9rem; color: var(--labs-grey);">Tone Match</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const btn = document.getElementById('analyzeBtn');
        const attachBtn = document.getElementById('attachBtn');
        const input = document.getElementById('videoUrlInput');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');

        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const percentText = document.getElementById('percentText');
        const resultsSection = document.getElementById('resultsSection');

        let selectedFiles = [];

        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });

        attachBtn.addEventListener('mouseover', () => {
            attachBtn.style.background = '#e8eaed';
        });

        attachBtn.addEventListener('mouseout', () => {
            attachBtn.style.background = '#f1f3f4';
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            renderFileList();
        }

        function renderFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }
            fileList.style.display = 'flex';
            fileList.style.flexWrap = 'wrap';
            fileList.style.gap = '0.5rem';

            fileList.innerHTML = selectedFiles.map(file => `
                <div style="background: #fff; border: 1px solid var(--labs-border); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìÑ</span>
                    <span style="font-weight: 500;">${file.name}</span>
                    <span style="color: #d93025; cursor: pointer; font-weight: bold; margin-left: 0.25rem;" onclick="removeFile('${file.name}')">√ó</span>
                </div>
            `).join('');
        }

        // Remove file helper
        window.removeFile = function (fileName) {
            selectedFiles = selectedFiles.filter(f => f.name !== fileName);
            renderFileList();
            // Reset file input so same file can be selected again if needed
            fileInput.value = '';
        }

        // Main Analyze Function
        async function startAnalysis() {
            const hasUrl = input.value.trim().length > 0;
            const hasFiles = selectedFiles.length > 0;

            if (!hasUrl && !hasFiles) {
                input.focus();
                return;
            }

            // Get user
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                window.location.href = 'login.html';
                return;
            }
            const user = JSON.parse(userJson);

            // UI State Change
            btn.disabled = true;
            btn.innerText = 'Analyzing...';
            btn.classList.add('analyzing-state');

            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            input.disabled = true;
            attachBtn.disabled = true;

            // Simulate Progress Bar for UX
            let width = 0;
            const interval = setInterval(() => {
                width += 5;
                if (width > 90) width = 90; // Hold at 90 until fetch done
                progressBar.style.width = width + '%';
                percentText.innerText = Math.round(width) + '%';
            }, 100);

            try {
                // Call Backend
                const response = await fetch('/api/analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        url: hasUrl ? input.value : (selectedFiles.length > 0 ? selectedFiles[0].name : "Unknown")
                    })
                });

                const result = await response.json();

                clearInterval(interval);
                progressBar.style.width = '100%';
                percentText.innerText = '100%';

                setTimeout(() => {
                    progressSection.style.display = 'none';
                    resultsSection.style.display = 'block';

                    if (result.success && result.data) {
                        const data = result.data;
                        document.getElementById('videoTitleElement').innerText = data.title;
                        document.getElementById('channelNameElement').innerText = data.channelName + " ‚Ä¢ " + data.views + " ‚Ä¢ " + data.uploadDate;
                        document.getElementById('videoSummaryElement').innerHTML = data.summary;

                        // Scores
                        document.querySelector('.card h4 + div span:first-child').innerText = data.craftScore;
                        document.querySelector('.card h4 + div span:last-child').innerText = data.comparison;

                        // Metrics
                        const metrics = document.querySelectorAll('.stat-card div:first-child');
                        if (metrics[0]) metrics[0].innerText = data.pacingScore;
                        if (metrics[1]) metrics[1].innerText = data.clarityScore;
                        if (metrics[2]) metrics[2].innerText = data.retention;
                        if (metrics[3]) metrics[3].innerText = data.toneMatch;
                    }

                    // Reset Buttons
                    btn.disabled = false;
                    btn.innerText = 'Analyze';
                    btn.classList.remove('analyzing-state');
                    input.disabled = false;
                    attachBtn.disabled = false;
                }, 500);

            } catch (e) {
                console.error(e);
                clearInterval(interval);
                alert("Analysis failed. Please try again.");
                btn.disabled = false;
                btn.innerText = 'Analyze';
                btn.classList.remove('analyzing-state');
                input.disabled = false;
                attachBtn.disabled = false;
                progressSection.style.display = 'none';
            }
        }

        // Attach event listener
        btn.addEventListener('click', startAnalysis);

        async function loadUserProfile() {
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                // Not logged in -> Redirect
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userJson);
            // Verify with backend
            try {
                const res = await fetch(`/api/user/me?userId=${user.id}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        // Update Navbar
                        const profileName = document.querySelector('.navbar a[href="settings.html"] span');
                        const profileAvatar = document.querySelector('.navbar a[href="settings.html"] div');

                        if (profileName) profileName.innerText = data.fullName;
                        if (profileAvatar && data.avatarUrl) {
                            profileAvatar.style.background = `url('${data.avatarUrl}') center/cover no-repeat`;
                        } else if (profileAvatar) {
                            profileAvatar.innerText = data.fullName.charAt(0).toUpperCase();
                            profileAvatar.style.display = "flex";
                            profileAvatar.style.alignItems = "center";
                            profileAvatar.style.justifyContent = "center";
                            profileAvatar.style.color = "white";
                            profileAvatar.style.fontWeight = "bold";
                        }
                    }
                } else {
                    // Session invalid?
                    // console.warn("Session check failed");
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Run on load
        document.addEventListener('DOMContentLoaded', loadUserProfile);
    </script>
</body>

</html>