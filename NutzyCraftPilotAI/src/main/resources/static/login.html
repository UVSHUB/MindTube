<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign In - Nutzy Craft PilotAI</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/components.css" />
    <script src="js/config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
      }

      .auth-card {
        padding: 3rem;
        text-align: center;
        max-width: 440px;
        width: 100%;
        background: white;
      }

      @media (max-width: 480px) {
        .auth-card {
          padding: 1.5rem;
        }
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--labs-grey);
      }

      .form-input {
        width: 100%;
        padding: 0.8rem 1rem;
        border-radius: 8px;
        /* Slightly squarer than buttons */
        border: 1px solid var(--labs-border);
        font-family: var(--font-body);
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--labs-blue);
      }

      .divider {
        display: flex;
        align-items: center;
        margin: 2rem 0;
        color: var(--labs-grey);
        font-size: 0.85rem;
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--labs-border);
      }

      .divider span {
        padding: 0 1rem;
      }

      .btn-google {
        background: white;
        color: var(--labs-black);
        border: 1px solid var(--labs-border);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
      }

      .password-wrapper {
        position: relative;
        width: 100%;
      }

      .toggle-password {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: var(--labs-grey);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
      }

      .toggle-password:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: var(--labs-black);
      }
    </style>
  </head>

  <body style="background-color: var(--labs-off-white)">
    <div
      class="container"
      style="
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      "
    >
      <div class="card auth-card">
        <!-- Logo -->
        <a
          href="index.html"
          class="logo"
          style="justify-content: center; margin-bottom: 2rem"
        >
          <img
            src="images/logo.jpg"
            alt="Nutzy Craft Logo"
            style="height: 48px; border-radius: 50%"
          />
          Nutzy Craft <span>PilotAI</span>
        </a>

        <h2 style="font-size: 2rem; margin-bottom: 0.5rem">Welcome back</h2>
        <p style="margin-bottom: 2rem">Please enter your details to sign in.</p>

        <!-- Social Login -->
        <div id="google_btn_wrapper" style="width: 100%; display: flex; justify-content: center;"></div>

        <!-- Old Button (Removed for GSI) -->
        <!-- <button class="btn btn-google"> ... </button> -->

        <div class="divider"><span>OR</span></div>

        <!-- Form -->
        <form action="dashboard.html">
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input
              type="email"
              class="form-input"
              placeholder="name@company.com"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <div class="password-wrapper">
              <input
                type="password"
                class="form-input"
                placeholder="••••••••"
                required
                id="passwordInput"
              />
              <button
                type="button"
                class="toggle-password"
                onclick="togglePassword('passwordInput', this)"
              >
                <!-- Eye Icon -->
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                    fill="currentColor"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 2rem;
              font-size: 0.9rem;
            "
          >
            <label
              style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
              "
            >
              <input type="checkbox" /> Remember me
            </label>
            <a
              href="forgot-password.html"
              style="color: var(--labs-blue); font-weight: 500"
              >Forgot password?</a
            >
          </div>

          <button
            type="submit"
            id="loginBtn"
            class="btn btn-primary"
            style="width: 100%"
          >
            Sign in
          </button>
        </form>
        <div id="loginResponse" style="margin-top: 1rem; display: none"></div>

        <script>
          // Initialize Google Sign-In
          function initGoogleSignIn() {
            google.accounts.id.initialize({
              client_id: "613986529272-5q7b4qaqb82i5en6r15r3dnr7l7acqm0.apps.googleusercontent.com",
              callback: handleCredentialResponse,
              auto_prompt: false
            });
            renderGoogleButton();
          }

          function renderGoogleButton() {
            const container = document.getElementById('google_btn_wrapper');
            // Calculate precise width
            const width = container.clientWidth || 300; 
            
            google.accounts.id.renderButton(
              container,
              { 
                type: "standard", 
                size: "large", 
                theme: "outline", 
                text: "sign_in_with", 
                shape: "rectangular",
                width: width
              }
            );
          }

          // Re-render on resize with debounce
          let resizeTimer;
          window.addEventListener('resize', () => {
              clearTimeout(resizeTimer);
              resizeTimer = setTimeout(() => {
                  // Clear old button
                  document.getElementById('google_btn_wrapper').innerHTML = '';
                  renderGoogleButton();
              }, 200);
          });

          // Load on window load
          window.onload = initGoogleSignIn;

          async function handleCredentialResponse(response) {
            // Send the JWT to your backend
            try {
              const res = await fetch(getApiUrl("/api/auth/google"), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token: response.credential }),
              });
              const result = await res.json();

              const responseDiv = document.getElementById("loginResponse");
              if (result.success) {
                responseDiv.style.display = "block";
                responseDiv.style.color = "#137333";
                responseDiv.innerText = "Google Login Successful!";
                localStorage.setItem(
                  "user",
                  JSON.stringify({ id: result.userId, name: result.fullName }),
                );
                setTimeout(
                  () => (window.location.href = "dashboard.html"),
                  1000,
                );
              } else {
                alert("Google Login Failed: " + result.message);
              }
            } catch (error) {
              console.error(error);
              alert("Google Login Error");
            }
          }

          document
            .querySelector("form")
            .addEventListener("submit", async function (e) {
              e.preventDefault();
              const email = this.querySelector('input[type="email"]').value;
              const password = document.getElementById("passwordInput").value;
              const btn = document.getElementById("loginBtn");
              const responseDiv = document.getElementById("loginResponse");

              btn.disabled = true;
              btn.innerText = "Signing in...";
              responseDiv.style.display = "none";

              try {
                const response = await fetch(getApiUrl("/api/auth/login"), {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ email, password }),
                });
                const result = await response.json();

                if (result.success) {
                  responseDiv.style.display = "block";
                  responseDiv.style.color = "#137333";
                  responseDiv.innerText = "Success! Redirecting...";
                  // Store generic token or user info if needed
                  localStorage.setItem(
                    "user",
                    JSON.stringify({
                      id: result.userId,
                      name: result.fullName,
                    }),
                  );
                  setTimeout(
                    () => (window.location.href = "dashboard.html"),
                    1000,
                  );
                } else {
                  responseDiv.style.display = "block";
                  responseDiv.style.color = "#d93025";
                  responseDiv.innerText = result.message;
                  btn.disabled = false;
                  btn.innerText = "Sign in";
                }
              } catch (error) {
                responseDiv.style.display = "block";
                responseDiv.style.color = "#d93025";
                responseDiv.innerText = "Connection error.";
                btn.disabled = false;
                btn.innerText = "Sign in";
              }
            });
        </script>

        <p style="margin-top: 2rem; font-size: 0.95rem">
          Don't have an account?
          <a
            href="signup.html"
            style="
              color: var(--labs-black);
              font-weight: 600;
              text-decoration: underline;
            "
            >Sign up</a
          >
        </p>

        <div
          style="
            margin-top: 2rem;
            border-top: 1px solid var(--labs-border);
            padding-top: 1.5rem;
          "
        >
          <a
            href="index.html"
            style="
              color: var(--labs-grey);
              font-size: 0.9rem;
              text-decoration: none;
            "
            >← Back to Home</a
          >
        </div>
      </div>
    </div>
    <script>
      function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        const icon = btn.querySelector("svg");

        if (input.type === "password") {
          input.type = "text";
          // Switch to Eye Off (Strikethrough)
          icon.innerHTML =
            '<path d="M11.83 9L15 12.17V12C15 10.34 13.66 9 12 9V9V4.5C17 4.5 21.27 7.61 23 12C21.27 16.39 17 19.5 12 19.5C10.53 19.5 9.13 19.23 7.82 18.73L9.36 17.19C10.19 17.39 11.07 17.5 12 17.5C14.76 17.5 17 15.26 17 12.5C17 12.39 16.99 12.28 16.97 12.17L11.83 7.03V9ZM6.2 4.29L3.92 6.57L2.49 5.14L1.36 4L2.78 2.58L21.41 21.21L19.99 22.63L17.7 20.34L17.3 19.94C15.76 20.93 13.94 21.5 12 21.5C7 21.5 2.73 18.39 1 14C2.18 11.01 4.53 8.64 7.55 7.42L6.2 6.07V4.29ZM12 14.5C12.65 14.5 13.25 14.25 13.72 13.84L9.16 9.28C8.75 9.75 8.5 10.35 8.5 11C8.5 12.93 10.07 14.5 12 14.5Z" fill="currentColor"/>';
        } else {
          input.type = "password";
          // Switch back to Eye
          icon.innerHTML =
            '<path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>';
        }
      }
    </script>
  </body>
</html>
