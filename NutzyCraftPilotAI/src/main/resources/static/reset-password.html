<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Nutzy Craft PilotAI</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="js/config.js"></script>
    <style>
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--labs-grey);
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            /* Slightly squarer than buttons */
            border: 1px solid var(--labs-border);
            font-family: var(--font-body);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--labs-blue);
        }

        .password-wrapper {
            position: relative;
            width: 100%;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--labs-grey);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .toggle-password:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--labs-black);
        }
    </style>
</head>

<body style="background-color: var(--labs-off-white);">
    <div class="container"
        style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem;">
        <div class="card" style="padding: 3rem; text-align: center; max-width: 440px; width: 100%; background: white;">
            <a href="index.html" class="logo" style="justify-content: center; margin-bottom: 2rem;">
                <img src="images/logo.jpg" alt="Nutzy Craft Logo" style="height: 48px; border-radius: 50%;">
                Nutzy Craft <span>PilotAI</span>
            </a>

            <h2 style="font-size: 2rem; margin-bottom: 0.5rem;">Reset Password</h2>
            <p style="margin-bottom: 2rem;">Enter your new password below.</p>

            <form>
                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="newPassword" class="form-input" placeholder="Enter new password"
                            required>
                        <button type="button" class="toggle-password" onclick="togglePassword('newPassword', this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                                    fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Confirm New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirmPassword" class="form-input"
                            placeholder="Confirm new password" required>
                        <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword', this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z"
                                    fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                </div>

                <button type="submit" id="resetBtn" class="btn btn-primary" style="width: 100%;">Reset Password</button>
            </form>
            <div id="resetResponse" style="margin-top: 1rem; display: none;"></div>

            <div style="margin-top: 2rem; border-top: 1px solid var(--labs-border); padding-top: 1.5rem;">
                <a href="login.html" style="color: var(--labs-grey); font-size: 0.9rem; text-decoration: none;">‚Üê Back
                    to Sign In</a>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('svg');

            if (input.type === "password") {
                input.type = "text";
                icon.innerHTML = '<path d="M11.83 9L15 12.17V12C15 10.34 13.66 9 12 9V9V4.5C17 4.5 21.27 7.61 23 12C21.27 16.39 17 19.5 12 19.5C10.53 19.5 9.13 19.23 7.82 18.73L9.36 17.19C10.19 17.39 11.07 17.5 12 17.5C14.76 17.5 17 15.26 17 12.5C17 12.39 16.99 12.28 16.97 12.17L11.83 7.03V9ZM6.2 4.29L3.92 6.57L2.49 5.14L1.36 4L2.78 2.58L21.41 21.21L19.99 22.63L17.7 20.34L17.3 19.94C15.76 20.93 13.94 21.5 12 21.5C7 21.5 2.73 18.39 1 14C2.18 11.01 4.53 8.64 7.55 7.42L6.2 6.07V4.29ZM12 14.5C12.65 14.5 13.25 14.25 13.72 13.84L9.16 9.28C8.75 9.75 8.5 10.35 8.5 11C8.5 12.93 10.07 14.5 12 14.5Z" fill="currentColor"/>';
            } else {
                input.type = "password";
                icon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>';
            }
        }

        document.querySelector('form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            const btn = document.getElementById('resetBtn');
            const responseDiv = document.getElementById('resetResponse');

            // Clear previous messages
            responseDiv.style.display = 'none';

            if (!token) {
                responseDiv.style.display = 'block';
                responseDiv.style.color = '#d93025';
                responseDiv.innerText = 'Invalid or missing reset token. Please check your email link.';
                return;
            }

            if (newPassword !== confirmPassword) {
                responseDiv.style.display = 'block';
                responseDiv.style.color = '#d93025';
                responseDiv.innerText = 'Passwords do not match.';
                return;
            }

            btn.disabled = true;
            btn.innerText = 'Resetting...';

            try {
                const response = await fetch(getApiUrl('/api/auth/reset-password'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, newPassword })
                });
                const result = await response.json();

                responseDiv.style.display = 'block';
                responseDiv.innerText = result.message;

                if (result.success) {
                    responseDiv.style.color = '#137333';
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    responseDiv.style.color = '#d93025';
                    btn.disabled = false;
                    btn.innerText = 'Reset Password';
                }
            } catch (error) {
                responseDiv.style.display = 'block';
                responseDiv.style.color = '#d93025';
                responseDiv.innerText = 'Something went wrong';
                btn.disabled = false;
                btn.innerText = 'Reset Password';
            }
        });
    </script>
</body>

</html>