<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Reports - Nutzy Craft PilotAI</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="js/config.js"></script>
</head>

<body style="background-color: #f8f9fa;">

    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="logo">
            <img src="images/logo.jpg" alt="Antigravity Acorn" style="height: 32px; border-radius: 50%;">
            Nutzy Craft <span>PilotAI</span>
        </a>



        <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
            <!-- Profile -->
            <a href="settings.html"
                style="display: flex; align-items: center; gap: 0.75rem; padding: 0.25rem 0.25rem 0.25rem 1rem; background: #fff; border: 1px solid var(--labs-border); border-radius: var(--radius-pill); text-decoration: none; color: inherit; transition: box-shadow 0.2s;">
                <span style="font-size: 0.9rem; font-weight: 500;"></span>
                <div
                    style="width: 32px; height: 32px; border-radius: 50%;">
                </div>
            </a>
        </div>
    </nav>

    <div class="console-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section-title">Workspace</div>
            <a href="dashboard.html" class="sidebar-link">Analysis Console</a>
            <a href="saved-reports.html" class="sidebar-link active">Saved Reports</a>
            <a href="trends.html" class="sidebar-link">Trends</a>

            <div class="sidebar-section-title">Account</div>
            <a href="settings.html" class="sidebar-link">Settings</a>

            <a href="signout.html" class="sidebar-link" style="color: #d93025; margin-top: 1rem;">Sign Out</a>
        </aside>

        <!-- Main Content -->
        <main>
            <div class="card" style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="font-size: 1.5rem; margin: 0;">Saved Reports</h2>
                    <div class="input-wrapper" style="width: auto; margin: 0;">
                        <input type="text" placeholder="Search reports..."
                            style="padding: 0.5rem 1rem; width: 250px; font-size: 0.9rem;">
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid #eee; text-align: left;">
                            <th style="padding: 1rem; font-weight: 600; color: var(--labs-grey);">Report Name / Video
                                URL</th>
                            <th style="padding: 1rem; font-weight: 600; color: var(--labs-grey);">Date</th>
                            <th style="padding: 1rem; font-weight: 600; color: var(--labs-grey);">Craft Score</th>
                            <th style="padding: 1rem; font-weight: 600; color: var(--labs-grey);">Status</th>
                            <th style="padding: 1rem; text-align: right; font-weight: 600; color: var(--labs-grey);">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- Content loaded via JS -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    <script>
        async function loadUserProfile() {
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userJson);
            try {
                const res = await fetch(getApiUrl(`/api/user/me?userId=${user.id}`));
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        // Update Navbar
                        const profileName = document.querySelector('.navbar a[href="settings.html"] span');
                        const profileAvatar = document.querySelector('.navbar a[href="settings.html"] div');

                        if (profileName) profileName.innerText = data.fullName || user.name || "User";
                        if (profileAvatar && data.avatarUrl) {
                            profileAvatar.style.background = 'none';
                            profileAvatar.style.backgroundImage = `url('${data.avatarUrl}')`;
                            profileAvatar.style.backgroundSize = 'cover';
                            profileAvatar.style.backgroundPosition = 'center';
                        } else if (profileAvatar) {
                            // Keep gradient if no avatar
                            profileAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                            profileAvatar.style.backgroundImage = 'none';
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading user profile:', e);
            }
        }

        async function loadReports() {
            // Load from LocalStorage
            const savedReports = JSON.parse(localStorage.getItem('savedReports') || '[]');

            const tbody = document.getElementById('reportsTableBody');
            tbody.innerHTML = '';

            if (savedReports.length > 0) {
                savedReports.forEach(report => {
                    const date = new Date(report.createdAt).toLocaleDateString("en-US", { year: 'numeric', month: 'short', day: 'numeric' });
                    const row = `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 1rem;">
                                <div style="font-weight: 500;">${report.title}</div>
                                <div style="font-size: 0.85rem; color: var(--labs-grey);">${report.videoUrl}</div>
                            </td>
                            <td style="padding: 1rem;">${date}</td>
                            <td style="padding: 1rem;">
                                <span style="font-weight: 700; color: ${getColorForScore(report.craftScore)};">${report.craftScore}</span>
                            </td>
                            <td style="padding: 1rem;"><span style="background: #e6f4ea; color: #137333; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 500;">Completed</span></td>
                            <td style="padding: 1rem; text-align: right;">
                                <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" onclick='viewReport(${JSON.stringify(report)})'>View</button>
                                <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; color: #d93025; background: none; border: none; cursor: pointer;" onclick="deleteReport(${report.id})">Delete</button>
                            </td>
                        </tr>
                     `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #666;">No saved reports found.</td></tr>';
            }
        }

        function getColorForScore(score) {
            if (score >= 90) return '#137333';
            if (score >= 70) return '#f9ab00';
            return '#d93025';
        }

        async function deleteReport(id) {
            if (!confirm("Are you sure?")) return;
            
            let reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
            reports = reports.filter(r => r.id !== id);
            localStorage.setItem('savedReports', JSON.stringify(reports));
            
            loadReports();
        }

        function viewReport(report) {
            // Simple view: Alert user (since we don't have a report detail page yet)
            // Or use a modal if we had one.
            alert(`Report: ${report.title}\n\nScore: ${report.craftScore}\nSummary: ${report.summary.replace(/<[^>]*>?/gm, '')}`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            loadReports();
        });
    </script>
    </div>
    </main>
    </div>
</body>

</html>