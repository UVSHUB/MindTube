<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trends - Nutzy Craft PilotAI</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body style="background-color: #f8f9fa;">

    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="logo">
            <img src="images/logo.jpg" alt="Antigravity Acorn" style="height: 32px; border-radius: 50%;">
            Nutzy Craft <span>PilotAI</span>
        </a>



        <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
            <!-- Profile -->
            <a href="settings.html"
                style="display: flex; align-items: center; gap: 0.75rem; padding: 0.25rem 0.25rem 0.25rem 1rem; background: #fff; border: 1px solid var(--labs-border); border-radius: var(--radius-pill); text-decoration: none; color: inherit; transition: box-shadow 0.2s;">
                <span style="font-size: 0.9rem; font-weight: 500;"></span>
                <div
                    style="width: 32px; height: 32px; border-radius: 50%;">
                </div>
            </a>
        </div>
    </nav>

    <div class="console-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section-title">Workspace</div>
            <a href="dashboard.html" class="sidebar-link">Analysis Console</a>
            <a href="saved-reports.html" class="sidebar-link">Saved Reports</a>
            <a href="trends.html" class="sidebar-link active">Trends</a>

            <div class="sidebar-section-title">Account</div>
            <a href="settings.html" class="sidebar-link">Settings</a>

            <a href="signout.html" class="sidebar-link" style="color: #d93025; margin-top: 1rem;">Sign Out</a>
        </aside>

        <!-- Main Content -->
        <main>
            <h2 style="font-size: 1.5rem; margin-bottom: 2rem;">Performance Trends</h2>

            <!-- Top Cards -->
            <!-- Top Cards -->
            <div class="grid grid-3" style="gap: 1.5rem; margin-bottom: 2rem;">
                <div class="card" style="background: #fff; border: 1px solid var(--labs-border); padding: 1.5rem;">
                    <div style="font-size: 0.9rem; color: var(--labs-grey); margin-bottom: 0.5rem;">Total Analyses</div>
                    <div style="font-size: 2.5rem; font-weight: 700;">0</div>
                    <div style="font-size: 0.85rem; color: #137333; margin-top: 0.5rem;">--</div>
                </div>
                <div class="card" style="background: #fff; border: 1px solid var(--labs-border); padding: 1.5rem;">
                    <div style="font-size: 0.9rem; color: var(--labs-grey); margin-bottom: 0.5rem;">Avg. Craft Score
                    </div>
                    <div style="font-size: 2.5rem; font-weight: 700;">0</div>
                    <div style="font-size: 0.85rem; color: #137333; margin-top: 0.5rem;">--</div>
                </div>
                <div class="card" style="background: #fff; border: 1px solid var(--labs-border); padding: 1.5rem;">
                    <div style="font-size: 0.9rem; color: var(--labs-grey); margin-bottom: 0.5rem;">Top Hook Score</div>
                    <div style="font-size: 2.5rem; font-weight: 700;">0</div>
                    <div style="font-size: 0.85rem; color: var(--labs-grey); margin-top: 0.5rem;">--</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="card"
                style="background: #fff; border: 1px solid var(--labs-border); padding: 2rem; min-height: 400px;">
                <h3 style="font-size: 1.1rem; margin-bottom: 2rem;">Craft Score History (Last 30 Days)</h3>

                <!-- Simple CSS Bar Chart Visualization -->
                <!-- Chart loaded via JS -->
                <div id="chartContainer"
                    style="display: flex; align-items: flex-end; justify-content: space-between; height: 300px; padding-bottom: 2rem; border-bottom: 1px solid #eee; width: 100%;">
                    <!-- Loading... -->
                </div>
            </div>
    </div>
    </main>
    </div>
    <script>
        async function loadUserProfile() {
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userJson);
            try {
                const res = await fetch(`/api/user/me?userId=${user.id}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        // Update Navbar
                        const profileName = document.querySelector('.navbar a[href="settings.html"] span');
                        const profileAvatar = document.querySelector('.navbar a[href="settings.html"] div');

                        if (profileName) profileName.innerText = data.fullName || user.name || "User";
                        if (profileAvatar && data.avatarUrl) {
                            profileAvatar.style.background = 'none';
                            profileAvatar.style.backgroundImage = `url('${data.avatarUrl}')`;
                            profileAvatar.style.backgroundSize = 'cover';
                            profileAvatar.style.backgroundPosition = 'center';
                        } else if (profileAvatar) {
                            // Keep gradient if no avatar
                            profileAvatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                            profileAvatar.style.backgroundImage = 'none';
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading user profile:', e);
            }
        }

        async function loadTrends() {
            const userJson = localStorage.getItem('user');
            if (!userJson) {
                window.location.href = 'login.html';
                return;
            }
            const user = JSON.parse(userJson);

            try {
                const res = await fetch(`/api/trends?userId=${user.id}`);
                const result = await res.json();

                if (result.success && result.data) {
                    const d = result.data;

                    // Cards
                    const cards = document.querySelectorAll('.grid-3 .card');
                    if (cards[0]) {
                        cards[0].children[1].innerText = d.totalAnalyses;
                        cards[0].children[2].innerText = `+${d.thisWeekCount} this week`;
                    }
                    if (cards[1]) {
                        cards[1].children[1].innerText = d.avgCraftScore;
                        cards[1].children[2].innerText = `${d.craftScoreTrend} vs last month`;
                    }
                    if (cards[2]) {
                        cards[2].children[1].innerText = d.topHookScore;
                        cards[2].children[2].innerText = `"${d.topHookVideo}"`;
                    }

                    // Chart
                    const chartContainer = document.getElementById('chartContainer');
                    chartContainer.innerHTML = '';

                    d.chart.forEach(point => {
                        const bar = `
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; width: 10%;">
                                <div style="height: 180px; width: 100%; background: #e8eaed; border-radius: 4px 4px 0 0; position: relative;">
                                    <div style="position: absolute; bottom: 0; width: 100%; height: ${point.value}%; background: ${point.value >= 90 ? '#1a73e8' : '#8ab4f8'}; border-radius: 4px 4px 0 0;">
                                    </div>
                                </div>
                                <span style="font-size: 0.8rem; color: var(--labs-grey);">${point.label}</span>
                            </div>
                        `;
                        chartContainer.insertAdjacentHTML('beforeend', bar);
                    });
                }

            } catch (e) { console.error(e); }
        }
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            loadTrends();
        });
    </script>
    </div>
    </main>
    </div>
</body>

</html>